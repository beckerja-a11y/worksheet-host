import { useState, useRef, useEffect } from 'react';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Card } from '@/components/ui/card';
import { Volume2, Trash2, Save } from 'lucide-react';
import { toast } from 'sonner';

const Day1 = () => {
  const [selectedFreedoms, setSelectedFreedoms] = useState<Set<number>>(new Set());
  const [draggedRight, setDraggedRight] = useState<string | null>(null);
  const [droppedRights, setDroppedRights] = useState<Record<string, string>>({});
  const [draggedConcept, setDraggedConcept] = useState<string | null>(null);
  const [matchedConcepts, setMatchedConcepts] = useState<Record<string, string>>({});
  const [freedomText, setFreedomText] = useState('');
  
  // Activity completion tracking
  const [activity1Complete, setActivity1Complete] = useState(false);
  const [activity2Complete, setActivity2Complete] = useState(false);
  const [activity3Complete, setActivity3Complete] = useState(false);
  const [activity4Complete, setActivity4Complete] = useState(false);
  
  const canvasRef = useRef<HTMLCanvasElement>(null);
  const [isDrawing, setIsDrawing] = useState(false);
  const [penColor, setPenColor] = useState('#000000');

  // Text-to-speech function
  const speak = (text: string, slow = true) => {
    if ('speechSynthesis' in window) {
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.rate = slow ? 0.9 : 1.0;
      utterance.pitch = 1.0;
      window.speechSynthesis.speak(utterance);
    } else {
      toast.error('Text-to-speech not supported in this browser');
    }
  };

  // Canvas drawing setup
  useEffect(() => {
    const canvas = canvasRef.current;
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    if (!ctx) return;
    
    const rect = canvas.getBoundingClientRect();
    canvas.width = rect.width;
    canvas.height = 240;
    
    ctx.fillStyle = 'white';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
  }, []);

  const startDrawing = (e: React.MouseEvent<HTMLCanvasElement> | React.TouchEvent<HTMLCanvasElement>) => {
    setIsDrawing(true);
    const canvas = canvasRef.current;
    if (!canvas) return;
    
    const rect = canvas.getBoundingClientRect();
    const x = 'touches' in e ? e.touches[0].clientX - rect.left : e.clientX - rect.left;
    const y = 'touches' in e ? e.touches[0].clientY - rect.top : e.clientY - rect.top;
    
    const ctx = canvas.getContext('2d');
    if (ctx) {
      ctx.beginPath();
      ctx.moveTo(x, y);
    }
  };

  const draw = (e: React.MouseEvent<HTMLCanvasElement> | React.TouchEvent<HTMLCanvasElement>) => {
    if (!isDrawing) return;
    
    const canvas = canvasRef.current;
    if (!canvas) return;
    
    const rect = canvas.getBoundingClientRect();
    const x = 'touches' in e ? e.touches[0].clientX - rect.left : e.clientX - rect.left;
    const y = 'touches' in e ? e.touches[0].clientY - rect.top : e.clientY - rect.top;
    
    const ctx = canvas.getContext('2d');
    if (ctx) {
      ctx.strokeStyle = penColor;
      ctx.lineWidth = 3;
      ctx.lineCap = 'round';
      ctx.lineTo(x, y);
      ctx.stroke();
    }
  };

  const stopDrawing = () => {
    setIsDrawing(false);
  };

  const clearCanvas = () => {
    const canvas = canvasRef.current;
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    if (ctx) {
      ctx.fillStyle = 'white';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
    }
  };

  const saveDrawing = () => {
    const canvas = canvasRef.current;
    if (!canvas) return;
    
    const link = document.createElement('a');
    link.download = 'my-freedom-drawing.png';
    link.href = canvas.toDataURL();
    link.click();
    toast.success('Drawing saved!');
  };

  const checkAnswer = (correct: boolean) => {
    if (correct) {
      toast.success('Correct! Great job!');
    } else {
      toast.error('Not quite. Try again!');
    }
  };

  const toggleFreedom = (index: number, correct: boolean) => {
    const newSelected = new Set(selectedFreedoms);
    if (newSelected.has(index)) {
      newSelected.delete(index);
    } else {
      newSelected.add(index);
    }
    setSelectedFreedoms(newSelected);

    if (newSelected.size === 3 && Array.from(newSelected).every(i => {
      const freedoms = [true, false, true, true];
      return freedoms[i];
    })) {
      setTimeout(() => {
        toast.success('Perfect! You found all three freedoms!');
        setActivity2Complete(true);
      }, 300);
    }
  };

  const freedomOptions = [
    { emoji: 'ðŸ˜„', label: 'Being happy', correct: true },
    { emoji: 'ðŸ”’ðŸ”—', label: 'Locked up', correct: false },
    { emoji: 'ðŸ§¸âš½', label: 'Play and fun', correct: true },
    { emoji: 'ðŸƒâ€â™€ï¸ðŸŒ³', label: 'Run and move', correct: true },
  ];

  const rights = [
    { id: 'live', label: 'The Right to LIVE', color: 'bg-accent text-accent-foreground' },
    { id: 'free', label: 'The Right to be FREE', color: 'bg-primary text-primary-foreground' },
    { id: 'happy', label: 'The Right to be HAPPY', color: 'bg-yellow-400 text-white' },
  ];

  const definitions = [
    { accept: 'happy', emoji: 'â­', text: 'To set goals and dream', border: 'border-yellow-400' },
    { accept: 'live', emoji: 'â¤ï¸', text: 'To be safe and healthy', border: 'border-accent' },
    { accept: 'free', emoji: 'ðŸƒ', text: 'To make choices and move', border: 'border-primary' },
  ];

  const handleDragStart = (e: React.DragEvent, rightId: string) => {
    setDraggedRight(rightId);
    e.dataTransfer.effectAllowed = 'move';
  };

  const handleDrop = (e: React.DragEvent, accept: string) => {
    e.preventDefault();
    if (draggedRight === accept) {
      const newDroppedRights = { ...droppedRights, [accept]: draggedRight };
      setDroppedRights(newDroppedRights);
      toast.success('Great match!');
      
      if (Object.keys(newDroppedRights).length === 3) {
        setTimeout(() => {
          toast.success('Perfect! You matched all three freedoms!');
          setActivity3Complete(true);
        }, 300);
      }
    } else {
      toast.error('Not quite. Try a different match!');
    }
    setDraggedRight(null);
  };

  // Activity 1: Declaration Concepts Matching
  const declarationConcepts = [
    { id: 'equal', label: 'All people are equal', color: 'bg-primary text-primary-foreground' },
    { id: 'rights', label: 'Rights from birth', color: 'bg-accent text-accent-foreground' },
    { id: 'govern', label: 'Government serves people', color: 'bg-purple-500 text-white' },
    { id: 'change', label: 'Can change bad rulers', color: 'bg-orange-500 text-white' },
  ];

  const declarationDefinitions = [
    { accept: 'equal', emoji: 'ðŸ‘¥', text: 'Everyone is the same', border: 'border-primary' },
    { accept: 'rights', emoji: 'ðŸŽ', text: 'Born with freedoms', border: 'border-accent' },
    { accept: 'govern', emoji: 'ðŸ¤', text: 'Leaders help us', border: 'border-purple-500' },
    { accept: 'change', emoji: 'âœ‹', text: 'Pick new leaders', border: 'border-orange-500' },
  ];

  const handleConceptDragStart = (e: React.DragEvent, conceptId: string) => {
    setDraggedConcept(conceptId);
    e.dataTransfer.effectAllowed = 'move';
  };

  const handleConceptDrop = (e: React.DragEvent, accept: string) => {
    e.preventDefault();
    if (draggedConcept === accept) {
      const newMatched = { ...matchedConcepts, [accept]: draggedConcept };
      setMatchedConcepts(newMatched);
      toast.success('Great match!');
      
      if (Object.keys(newMatched).length === 4) {
        setTimeout(() => {
          toast.success('Perfect! You matched all four key ideas!');
          setActivity1Complete(true);
        }, 300);
      }
    } else {
      toast.error('Not quite. Try a different match!');
    }
    setDraggedConcept(null);
  };

  const downloadCertificate = () => {
    const canvas = document.createElement('canvas');
    canvas.width = 800;
    canvas.height = 600;
    const ctx = canvas.getContext('2d');
    if (!ctx) return;

    // Background
    ctx.fillStyle = '#f8f9fa';
    ctx.fillRect(0, 0, 800, 600);
    
    // Border
    ctx.strokeStyle = '#3b82f6';
    ctx.lineWidth = 20;
    ctx.strokeRect(20, 20, 760, 560);
    
    // Title
    ctx.fillStyle = '#1e40af';
    ctx.font = 'bold 48px Arial';
    ctx.textAlign = 'center';
    ctx.fillText('Certificate of Completion', 400, 120);
    
    // Subtitle
    ctx.font = '32px Arial';
    ctx.fillStyle = '#4b5563';
    ctx.fillText('Day 1: My Freedoms', 400, 180);
    
    // Student section
    ctx.font = '24px Arial';
    ctx.fillText('This certifies that', 400, 280);
    
    // Student name line
    ctx.strokeStyle = '#6b7280';
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(250, 340);
    ctx.lineTo(550, 340);
    ctx.stroke();
    ctx.fillText('Student Name', 400, 335);
    
    // Completion text
    ctx.fillText('has successfully completed all activities', 400, 400);
    ctx.fillText('about the Declaration of Independence', 400, 440);
    
    // Date
    ctx.font = '20px Arial';
    const today = new Date().toLocaleDateString();
    ctx.fillText(`Date: ${today}`, 400, 520);

    // Download
    const link = document.createElement('a');
    link.download = 'day1-certificate.png';
    link.href = canvas.toDataURL();
    link.click();
    toast.success('Certificate downloaded!');
  };

  const handleDragOver = (e: React.DragEvent) => {
    e.preventDefault();
  };

  return (
    <div className="min-h-screen bg-background py-8 px-4 md:px-8">
      <header className="text-center mb-8">
        <h1 className="text-4xl md:text-5xl font-extrabold text-primary mb-2">
          Day 1: My Freedoms
        </h1>
        <p className="text-xl text-muted-foreground">
          A simple lesson about the Declaration of Independence
        </p>
      </header>

      <main className="max-w-5xl mx-auto space-y-8">
        {/* I CAN Goals */}
        <Card className="bg-accent-light border-l-4 border-accent p-6">
          <p className="font-bold text-xl mb-3">ðŸŒŸ Today I Can:</p>
          <ul className="list-disc ml-8 text-lg space-y-2 text-foreground">
            <li>Say what the "Go-Free Paper" is.</li>
            <li>Name three freedoms people have.</li>
            <li>Draw a picture of a freedom I like.</li>
          </ul>
        </Card>

        {/* Reading Section */}
        <section className="space-y-4">
          <h2 className="text-3xl font-bold text-primary">Reading: The Go-Free Paper</h2>
          
          <div className="space-y-4">
            <Card className="bg-primary-light p-5">
              <div className="flex items-start gap-4">
                <div className="flex-1">
                  <p className="text-lg leading-relaxed mb-3">
                    A long time ago, people in America wrote a paper. It told why they wanted freedom.
                  </p>
                  <p className="text-sm text-muted-foreground">
                    (This paper is called the <strong>Declaration of Independence</strong>.)
                  </p>
                </div>
                <Button 
                  onClick={() => speak('A long time ago, people in America wrote a paper. It told why they wanted freedom.')}
                  size="lg"
                  className="shrink-0"
                >
                  <Volume2 className="w-5 h-5" />
                </Button>
              </div>
            </Card>

            <Card className="bg-primary-light p-5">
              <div className="flex items-start gap-4">
                <div className="flex-1">
                  <p className="text-lg leading-relaxed mb-3">
                    The paper said people are born with rights. That means people have things they should always have.
                  </p>
                  <p className="text-sm text-muted-foreground">
                    (We call these <strong>My Freedoms</strong>.)
                  </p>
                </div>
                <Button 
                  onClick={() => speak('The paper said people are born with rights. That means people have things they should always have.')}
                  size="lg"
                  className="shrink-0"
                >
                  <Volume2 className="w-5 h-5" />
                </Button>
              </div>
            </Card>

            <Card className="bg-primary-light p-5">
              <div className="flex items-start gap-4">
                <div className="flex-1">
                  <p className="text-lg leading-relaxed">
                    The three big freedoms are: <strong>to live</strong>, <strong>to be free</strong>, and <strong>to be happy</strong>.
                  </p>
                </div>
                <Button 
                  onClick={() => speak('The three big freedoms are: to live, to be free, and to be happy.')}
                  size="lg"
                  className="shrink-0"
                >
                  <Volume2 className="w-5 h-5" />
                </Button>
              </div>
            </Card>
          </div>

          {/* Comprehension Check */}
          <div className="mt-6">
            <h3 className="font-semibold text-xl text-primary mb-3">Check for Understanding</h3>
            <p className="text-lg text-foreground mb-4">What is the "Go-Free Paper"?</p>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <Button
                onClick={() => checkAnswer(true)}
                variant="outline"
                size="lg"
                className="h-auto p-5 text-left justify-start text-lg hover:bg-success-light hover:border-success"
              >
                The Declaration of Independence
              </Button>
              <Button
                onClick={() => checkAnswer(false)}
                variant="outline"
                size="lg"
                className="h-auto p-5 text-left justify-start text-lg hover:bg-destructive/10 hover:border-destructive"
              >
                A rule book for school
              </Button>
            </div>
          </div>
        </section>

        {/* Activity 1: Declaration Key Ideas Matching */}
        <section>
          <div className="flex items-center justify-between mb-4">
            <h2 className="text-3xl font-bold text-primary">Activity 1: Match the Big Ideas</h2>
            {activity1Complete && (
              <span className="text-success text-xl font-bold">âœ“ Complete</span>
            )}
          </div>
          <p className="text-lg text-muted-foreground mb-6">
            Drag each <strong>big idea</strong> to the simple words that mean the same thing.
          </p>

          <div className="flex flex-wrap gap-4 p-6 rounded-xl bg-primary-light mb-6">
            {declarationConcepts.map((concept) => (
              !matchedConcepts[concept.id] && (
                <div
                  key={concept.id}
                  draggable
                  onDragStart={(e) => handleConceptDragStart(e, concept.id)}
                  className={`${concept.color} px-6 py-4 rounded-lg shadow-md cursor-grab active:cursor-grabbing hover:scale-105 transition-all font-semibold text-lg`}
                >
                  {concept.label}
                </div>
              )
            ))}
          </div>

          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            {declarationDefinitions.map((def) => (
              <div
                key={def.accept}
                onDragOver={handleDragOver}
                onDrop={(e) => handleConceptDrop(e, def.accept)}
                className={`border-4 border-dashed ${def.border} rounded-xl p-6 min-h-[180px] flex flex-col items-center justify-center text-center transition-all ${
                  matchedConcepts[def.accept] 
                    ? 'bg-success-light border-success' 
                    : 'hover:bg-primary-light/30'
                }`}
              >
                <span className="text-5xl mb-4" role="img">{def.emoji}</span>
                <p className="font-semibold text-xl mb-2">{def.text}</p>
                {matchedConcepts[def.accept] && (
                  <p className="text-sm text-success font-bold mt-2">âœ“ Matched!</p>
                )}
              </div>
            ))}
          </div>
        </section>

        {/* Activity 2: Find the Freedoms */}
        <section>
          <div className="flex items-center justify-between mb-4">
            <h2 className="text-3xl font-bold text-primary">Activity 2: Find the Freedoms</h2>
            {activity2Complete && (
              <span className="text-success text-xl font-bold">âœ“ Complete</span>
            )}
          </div>
          <p className="text-lg text-muted-foreground mb-6">
            Tap or click the <strong>three pictures</strong> that show a freedom.
          </p>

          <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
            {freedomOptions.map((option, index) => (
              <Card
                key={index}
                onClick={() => toggleFreedom(index, option.correct)}
                className={`p-6 text-center cursor-pointer transition-all hover:scale-105 ${
                  selectedFreedoms.has(index)
                    ? option.correct
                      ? 'bg-success-light border-success border-4'
                      : 'bg-destructive/10 border-destructive border-4'
                    : 'hover:shadow-md'
                }`}
              >
                <span className="text-6xl block mb-3" role="img">{option.emoji}</span>
                <p className="text-base text-muted-foreground">{option.label}</p>
              </Card>
            ))}
          </div>
        </section>

        {/* Activity 3: Match the Freedoms */}
        <section>
          <div className="flex items-center justify-between mb-4">
            <h2 className="text-3xl font-bold text-primary">Activity 3: Match the Three Freedoms</h2>
            {activity3Complete && (
              <span className="text-success text-xl font-bold">âœ“ Complete</span>
            )}
          </div>
          <p className="text-lg text-muted-foreground mb-6">
            Drag each right card to the matching picture and sentence.
          </p>

          <div className="flex flex-wrap gap-4 p-6 rounded-xl bg-primary-light mb-6">
            {rights.map((right) => (
              !droppedRights[right.id] && (
                <div
                  key={right.id}
                  draggable
                  onDragStart={(e) => handleDragStart(e, right.id)}
                  className={`${right.color} px-6 py-4 rounded-lg shadow-md cursor-grab active:cursor-grabbing hover:scale-105 transition-all font-semibold text-lg`}
                >
                  {right.label}
                </div>
              )
            ))}
          </div>

          <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
            {definitions.map((def) => (
              <div
                key={def.accept}
                onDragOver={handleDragOver}
                onDrop={(e) => handleDrop(e, def.accept)}
                className={`border-4 border-dashed ${def.border} rounded-xl p-6 min-h-[200px] flex flex-col items-center justify-center text-center transition-all ${
                  droppedRights[def.accept] 
                    ? 'bg-success-light border-success' 
                    : 'hover:bg-primary-light/30'
                }`}
              >
                <span className="text-5xl mb-4" role="img">{def.emoji}</span>
                <p className="font-semibold text-lg mb-2">{def.text}</p>
                {droppedRights[def.accept] && (
                  <p className="text-sm text-success font-bold mt-2">âœ“ Matched!</p>
                )}
              </div>
            ))}
          </div>
        </section>

        {/* Activity 4: Draw Your Freedom */}
        <section>
          <div className="flex items-center justify-between mb-4">
            <h2 className="text-3xl font-bold text-primary">Activity 4: Draw Your Freedom</h2>
            {activity4Complete && (
              <span className="text-success text-xl font-bold">âœ“ Complete</span>
            )}
          </div>
          <p className="text-lg text-muted-foreground mb-6">
            Draw a picture of your favorite freedom. Write a short sentence too.
          </p>

          <Card className="p-6 space-y-4">
            <div className="flex items-center gap-4 flex-wrap">
              <label htmlFor="penColor" className="font-medium text-lg">Pen Color:</label>
              <input
                type="color"
                id="penColor"
                value={penColor}
                onChange={(e) => setPenColor(e.target.value)}
                className="w-14 h-14 rounded-lg border-2 cursor-pointer"
              />
              <Button onClick={clearCanvas} variant="outline" size="lg">
                <Trash2 className="w-5 h-5 mr-2" />
                Clear
              </Button>
              <Button onClick={saveDrawing} className="ml-auto" size="lg">
                <Save className="w-5 h-5 mr-2" />
                Save Image
              </Button>
            </div>

            <canvas
              ref={canvasRef}
              onMouseDown={startDrawing}
              onMouseMove={draw}
              onMouseUp={stopDrawing}
              onMouseLeave={stopDrawing}
              onTouchStart={startDrawing}
              onTouchMove={draw}
              onTouchEnd={stopDrawing}
              className="border-2 rounded-lg bg-white w-full cursor-crosshair touch-none"
              style={{ height: '240px' }}
            />

            <div>
              <label htmlFor="freedomLabel" className="block text-lg font-medium mb-3">
                My favorite freedom is:
              </label>
              <Input
                id="freedomLabel"
                value={freedomText}
                onChange={(e) => {
                  setFreedomText(e.target.value);
                  if (e.target.value.trim().length > 0) {
                    setActivity4Complete(true);
                  }
                }}
                placeholder="Example: playing outside with friends"
                className="text-lg p-6"
              />
            </div>
          </Card>
        </section>

        {/* Optional Stretch */}
        <Card className="bg-primary-light border-l-4 border-primary p-6">
          <h3 className="font-bold text-primary text-xl mb-3">ðŸ’­ Think Hard (optional)</h3>
          <p className="text-lg text-foreground mb-4">
            Why do you think people wanted to make their own rules? Say one reason in your own words.
          </p>
          <Button 
            onClick={() => speak('Why do you think people wanted to make their own rules? Say one reason in your own words.')}
            variant="outline"
            size="lg"
          >
            <Volume2 className="w-5 h-5 mr-2" />
            Listen
          </Button>
        </Card>

        {/* Finish Button - Only shows when all activities are complete */}
        {activity1Complete && activity2Complete && activity3Complete && activity4Complete && (
          <Card className="bg-success-light border-4 border-success p-8 text-center">
            <h3 className="text-3xl font-bold text-success mb-4">ðŸŽ‰ Amazing Work!</h3>
            <p className="text-xl text-foreground mb-6">
              You completed all activities! Download your certificate to submit to your teacher.
            </p>
            <Button 
              onClick={downloadCertificate}
              size="lg"
              className="text-xl px-8 py-6"
            >
              Download Certificate
            </Button>
          </Card>
        )}
      </main>
    </div>
  );
};

export default Day1;
