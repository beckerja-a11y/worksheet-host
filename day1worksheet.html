<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Day 1: My Freedoms (Natural Rights)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
    :root{
      --primary-600: #2563eb; /* soft blue */
      --primary-400: #60a5fa;
      --accent-500: #f59e0b; /* warm yellow */
      --muted-100: #f8fafc;
      --card-border: rgba(37,99,235,0.12);
    }
    body{
      font-family: 'Inter', sans-serif;
      background-color: var(--muted-100);
    }
    .concept-card { cursor: grab; transition: transform 0.18s, box-shadow 0.18s; border: 4px solid rgba(245,158,11,0.08); }
    .concept-card:active { cursor: grabbing; box-shadow: 0 10px 20px rgba(99,102,241,0.12); transform: scale(1.03); }
    .freedom-option { transition: all 0.16s; cursor: pointer; box-shadow: 0 2px 6px rgba(2,6,23,0.06); }
    .freedom-option:hover { transform: scale(1.03); box-shadow: 0 6px 14px rgba(2,6,23,0.08); }
    .selected { border: 4px solid #10b981; background-color: #d1fae5; }
    .drag-item { cursor: grab; transition: opacity 0.12s; min-width: 100px; }
    .drag-item.dragging { opacity: 0.5; }
    .drop-target { background-color: #ffffff; transition: background-color .12s, border-color .12s; min-height: 160px; }
    .drop-target.drag-over { background-color: #eff6ff; border-color: var(--primary-600); }
    .drop-target.dropped { border-color: #10b981 !important; background-color: #d1fae5; }
    .feedback { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%); padding: 16px 20px; border-radius: 10px; box-shadow: 0 12px 30px rgba(2,6,23,0.2); z-index: 1000; color: white; font-weight:700; }
    .tooltip-inner { display:none; position:absolute; z-index: 50; width: 220px; background: white; border:1px solid rgba(2,6,23,0.06); padding:8px; border-radius:8px; box-shadow:0 8px 20px rgba(2,6,23,0.08); }
    .glossary-term:hover .tooltip-inner, .glossary-term:focus-within .tooltip-inner { display:block; }
    /* small helper for visually hidden text (screen readers) */
    .sr-only { position: absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }
    /* canvas fallback size */
    #drawingCanvas { width: 100%; height: 240px; }
  </style>
</head>
<body class="p-4 md:p-8 text-gray-800">

  <header class="text-center mb-6">
    <h1 class="text-3xl md:text-4xl font-extrabold text-[color:var(--primary-600)] mb-2">Day 1: My Freedoms</h1>
    <p class="text-lg text-gray-700">A simple lesson about the Declaration of Independence</p>
  </header>

  <main class="max-w-4xl mx-auto bg-white p-6 rounded-xl shadow-lg">

    <!-- I CAN Goals -->
    <section class="mb-6">
      <div class="bg-yellow-50 border-l-4 border-[color:var(--accent-500)] p-4 rounded-md">
        <p class="font-bold text-lg">🌟 Today I Can:</p>
        <ul class="list-disc ml-6 text-gray-700 mt-2">
          <li>Say what the "Go-Free Paper" is.</li>
          <li>Name three freedoms people have.</li>
          <li>Draw a picture of a freedom I like.</li>
        </ul>
      </div>
    </section>

    <!-- Reading section -->
    <section class="mb-6 border-b pb-4">
      <div class="flex items-start justify-between gap-4">
        <div>
          <h2 class="text-2xl font-bold text-[color:var(--primary-600)] mb-2">Reading: The Go-Free Paper</h2>

          <!-- chunked text with audio -->
          <article class="space-y-3 text-lg text-gray-700">
            <div class="bg-blue-50 p-3 rounded-md flex items-start gap-3">
              <div class="flex-1">
                <p id="p1" class="leading-relaxed">
                  A long time ago, people in America wrote a paper. It told why they wanted freedom.
                </p>
                <p class="text-sm text-gray-500 mt-2">(This paper is called the <strong>Declaration of Independence</strong>.)</p>
              </div>
              <div class="shrink-0">
                <button class="px-3 py-2 bg-[color:var(--primary-600)] text-white rounded-md shadow-sm" onclick="speakChunk('A long time ago, people in America wrote a paper. It told why they wanted freedom.', true)" aria-label="Read paragraph 1 aloud">🔊 Listen</button>
              </div>
            </div>

            <div class="bg-blue-50 p-3 rounded-md flex items-start gap-3">
              <div class="flex-1">
                <p id="p2" class="leading-relaxed">
                  The paper said people are born with rights. That means people have things they should always have.
                </p>
                <p class="text-sm text-gray-500 mt-2">(We call these <strong>My Freedoms</strong>.)</p>
              </div>
              <div class="shrink-0">
                <button class="px-3 py-2 bg-[color:var(--primary-600)] text-white rounded-md shadow-sm" onclick="speakChunk('The paper said people are born with rights. That means people have things they should always have.', true)" aria-label="Read paragraph 2 aloud">🔊 Listen</button>
              </div>
            </div>

            <div class="bg-blue-50 p-3 rounded-md flex items-start gap-3">
              <div class="flex-1">
                <p id="p3" class="leading-relaxed">
                  The three big freedoms are: <strong>to live</strong>, <strong>to be free</strong>, and <strong>to be happy</strong>.
                </p>
              </div>
              <div class="shrink-0">
                <button class="px-3 py-2 bg-[color:var(--primary-600)] text-white rounded-md shadow-sm" onclick="speakChunk('The three big freedoms are: to live, to be free, and to be happy.', true)" aria-label="Read paragraph 3 aloud">🔊 Listen</button>
              </div>
            </div>
          </article>
        </div>

        <!-- Picture glossary -->
        <aside class="w-44 hidden md:block">
          <h3 class="font-semibold text-[color:var(--primary-600)] mb-2">Word Help</h3>
          <ul class="space-y-3 text-sm">
            <li class="glossary-term relative p-2 rounded-md bg-white border">
              <strong>Declaration</strong>
              <div class="tooltip-inner left-0 -top-2 -translate-y-full">
                <div class="flex items-center gap-2">
                  <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='36' height='36' viewBox='0 0 24 24' fill='%232563eb'><path d='M3 5h18v2H3zm0 6h18v2H3zm0 6h18v2H3z' /></svg>" alt="" class="w-8 h-8" />
                  <div>
                    <p class="font-semibold">Declaration</p>
                    <p class="text-xs text-gray-600">A paper that tells an important idea.</p>
                  </div>
                </div>
              </div>
            </li>

            <li class="glossary-term relative p-2 rounded-md bg-white border">
              <strong>Freedom</strong>
              <div class="tooltip-inner left-0 -top-2 -translate-y-full">
                <div class="flex items-center gap-2">
                  <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='36' height='36' viewBox='0 0 24 24' fill='%23f59e0b'><path d='M12 2l3 7h7l-5.5 4 2 7L12 16l-6.5 4 2-7L2 9h7z'/></svg>" alt="" class="w-8 h-8" />
                  <div>
                    <p class="font-semibold">Freedom</p>
                    <p class="text-xs text-gray-600">When you can choose and move safely.</p>
                  </div>
                </div>
              </div>
            </li>

            <li class="glossary-term relative p-2 rounded-md bg-white border">
              <strong>Rights</strong>
              <div class="tooltip-inner left-0 -top-2 -translate-y-full">
                <div class="flex items-center gap-2">
                  <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='36' height='36' viewBox='0 0 24 24' fill='%231f2937'><path d='M12 2C7.03 2 3 6.03 3 11c0 5.25 8.25 11 9 11s9-5.75 9-11c0-4.97-4.03-9-9-9z'/></svg>" alt="" class="w-8 h-8" />
                  <div>
                    <p class="font-semibold">Rights</p>
                    <p class="text-xs text-gray-600">Things people should have because they are people.</p>
                  </div>
                </div>
              </div>
            </li>

          </ul>
        </aside>
      </div>

      <!-- Simple comprehension check -->
      <div class="mt-4">
        <h3 class="font-semibold text-[color:var(--primary-600)]">Check for Understanding</h3>
        <p class="text-gray-700 mt-2">What is the "Go-Free Paper"?</p>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-3">
          <button onclick="checkAnswer(this, true)" class="p-3 bg-white rounded-md border hover:bg-green-50 text-left">The Declaration of Independence</button>
          <button onclick="checkAnswer(this, false)" class="p-3 bg-white rounded-md border hover:bg-red-50 text-left">A rule book for school</button>
        </div>
      </div>
    </section>

    <!-- Activity 1: Save the Idea Card -->
    <section class="mb-6">
      <h2 class="text-2xl font-bold text-[color:var(--primary-600)] mb-2">Activity 1: Save the Idea Card</h2>
      <p class="text-gray-600 mb-4">Drag the <strong>Idea Card</strong> into the box. We will use this idea later.</p>

      <div class="flex flex-col md:flex-row items-center gap-4">
        <div id="ideaCard" class="concept-card bg-white p-4 rounded-lg shadow w-full md:w-1/3" draggable="true" data-concept="Natural Rights" aria-grabbed="false" role="img" aria-label="Idea card: My Freedoms">
          <p class="text-3xl font-extrabold text-[color:var(--accent-500)]">My Freedoms</p>
          <p class="text-sm text-gray-500 mt-1">(The Declaration)</p>
        </div>

        <div id="dropTarget" class="bg-gray-50 border-4 border-dashed border-gray-300 p-6 rounded-lg w-full md:w-1/2 h-32 flex items-center justify-center text-gray-500" aria-dropeffect="move">
          <p id="dropText">Drop the Idea Card here to save it</p>
        </div>
      </div>
    </section>

    <!-- Activity 2: Find the Freedoms -->
    <section class="mb-6">
      <h2 class="text-2xl font-bold text-[color:var(--primary-600)] mb-3">Activity 2: Find the Freedoms</h2>
      <p class="text-gray-600 mb-3">Tap or click the <strong>three pictures</strong> that show a freedom.</p>

      <div id="freedomOptions" class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div class="freedom-option bg-white p-4 rounded-md text-center" data-correct="true" role="button" tabindex="0" aria-pressed="false">
          <span class="text-5xl" role="img" aria-label="smiling face">😄</span>
          <p class="text-sm text-gray-500 mt-2">Being happy</p>
        </div>

        <div class="freedom-option bg-white p-4 rounded-md text-center" data-correct="false" role="button" tabindex="0" aria-pressed="false">
          <span class="text-5xl" role="img" aria-label="locked chain">🔒🔗</span>
          <p class="text-sm text-gray-500 mt-2">Locked up</p>
        </div>

        <div class="freedom-option bg-white p-4 rounded-md text-center" data-correct="true" role="button" tabindex="0" aria-pressed="false">
          <span class="text-5xl" role="img" aria-label="child playing">🧸⚽</span>
          <p class="text-sm text-gray-500 mt-2">Play and fun</p>
        </div>

        <div class="freedom-option bg-white p-4 rounded-md text-center" data-correct="true" role="button" tabindex="0" aria-pressed="false">
          <span class="text-5xl" role="img" aria-label="running outside">🏃‍♀️🌳</span>
          <p class="text-sm text-gray-500 mt-2">Run and move</p>
        </div>
      </div>
    </section>

    <!-- Activity 3: Match the Freedoms -->
    <section class="mb-6">
      <h2 class="text-2xl font-bold text-[color:var(--primary-600)] mb-3">Activity 3: Match the Three Freedoms</h2>
      <p class="text-gray-600 mb-3">Drag each right card to the matching picture and sentence.</p>

      <div id="dragRights" class="flex flex-wrap gap-3 p-4 rounded-md bg-blue-50 mb-4">
        <div id="drag-live" class="drag-item bg-[color:var(--accent-500)] text-white p-3 rounded-md shadow cursor-grab" draggable="true" data-right="live" role="button" aria-grabbed="false">
          The Right to LIVE
        </div>

        <div id="drag-free" class="drag-item bg-[color:var(--primary-600)] text-white p-3 rounded-md shadow cursor-grab" draggable="true" data-right="free" role="button" aria-grabbed="false">
          The Right to be FREE
        </div>

        <div id="drag-happy" class="drag-item bg-yellow-400 text-white p-3 rounded-md shadow cursor-grab" draggable="true" data-right="happy" role="button" aria-grabbed="false">
          The Right to be HAPPY
        </div>
      </div>

      <div id="dropDefinitions" class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="drop-target p-4 border-4 border-dashed border-yellow-300 rounded-xl text-center flex flex-col items-center justify-center" data-accept="happy" aria-dropeffect="move">
          <span class="text-4xl mb-2" role="img" aria-label="star">⭐</span>
          <p class="font-semibold text-gray-700">To set goals and dream</p>
        </div>

        <div class="drop-target p-4 border-4 border-dashed border-[color:var(--accent-500)] rounded-xl text-center flex flex-col items-center justify-center" data-accept="live" aria-dropeffect="move">
          <span class="text-4xl mb-2" role="img" aria-label="heart">❤️</span>
          <p class="font-semibold text-gray-700">To be safe and healthy</p>
        </div>

        <div class="drop-target p-4 border-4 border-dashed border-[color:var(--primary-400)] rounded-xl text-center flex flex-col items-center justify-center" data-accept="free" aria-dropeffect="move">
          <span class="text-4xl mb-2" role="img" aria-label="running">🏃</span>
          <p class="font-semibold text-gray-700">To make choices and move</p>
        </div>
      </div>

      <div id="dragDropFeedback" class="text-center mt-4 text-lg font-bold text-gray-600"></div>
    </section>

    <!-- Activity 4: Draw Your Freedom -->
    <section class="mb-6">
      <h2 class="text-2xl font-bold text-[color:var(--primary-600)] mb-3">Activity 4: Draw Your Freedom</h2>
      <p class="text-gray-600 mb-3">Draw a picture of your favorite freedom. Write a short sentence too.</p>

      <div class="p-4 bg-gray-50 rounded-md">
        <div class="flex items-center gap-3 mb-3">
          <label for="penColor" class="font-medium">Pen Color:</label>
          <input type="color" id="penColor" value="#000000" class="w-10 h-10 rounded-full border" aria-label="Pen color" />
          <button id="clearButton" class="ml-3 px-3 py-2 bg-[color:var(--primary-600)] text-white rounded-md">Clear</button>

          <button id="saveImageBtn" class="ml-auto px-3 py-2 bg-[color:var(--accent-500)] text-white rounded-md" title="Save drawing as image">Save Image</button>
        </div>

        <canvas id="drawingCanvas" class="border rounded-md bg-white" aria-label="Drawing pad area"></canvas>

        <label for="freedomLabel" class="block text-gray-700 font-medium mt-4 mb-2">My favorite freedom is:</label>
        <input type="text" id="freedomLabel" class="w-full p-3 border border-gray-300 rounded-md" placeholder="Example: playing outside with friends" />
      </div>
    </section>

    <!-- Optional stretch -->
    <section class="mb-6">
      <div class="bg-blue-50 p-4 rounded-md border-l-4 border-[color:var(--primary-600)]">
        <h3 class="font-bold text-[color:var(--primary-600)]">💭 Think Hard (optional)</h3>
        <p class="text-gray-700 mt-2">Why do you think people wanted to make their own rules? Say one reason in your own words.</p>
        <button class="mt-3 px-3 py-2 bg-white border rounded-md" onclick="speakChunk('Why do you think people wanted to make their own rules? Say one reason in your own words.', true)">🔊 Listen</button>
      </div>
    </section>

  </main>

  <!-- feedback box (centered) -->
  <div id="feedbackBox" class="feedback" role="status" aria-live="polite"></div>

  <script>
    /***********************
      Speech synthesis helpers
    ***********************/
    let chosenVoice = null;
    const preferLang = 'en-US'; // neutral American English
    const synth = window.speechSynthesis;

    function pickVoice() {
      // pick best matching voice with en-US if available
      const voices = synth.getVoices();
      if (!voices || voices.length === 0) return null;

      // try to find common names for a neutral en-US voice
      const candidates = voices.filter(v => v.lang && v.lang.startsWith(preferLang));

      // prefer female/neutral voice names commonly available
      const preferNames = ['Google US English', 'Alex', 'Samantha', 'Daniel', 'Microsoft Zira', 'Alloy', 'en-US'];
      for (const name of preferNames) {
        const v = candidates.find(x => x.name && x.name.toLowerCase().includes(name.toLowerCase()));
        if (v) {
          chosenVoice = v;
          return v;
        }
      }
      // fallback to first en-US voice, or first voice overall
      chosenVoice = candidates[0] || voices[0];
      return chosenVoice;
    }

    // some browsers load voices asynchronously
    function ensureVoiceReady() {
      return new Promise(resolve => {
        let voices = synth.getVoices();
        if (voices.length) {
          pickVoice();
          resolve();
          return;
        }
        // wait for voiceschanged event
        synth.addEventListener('voiceschanged', () => {
          pickVoice();
          resolve();
        });
        // fallback timeout
        setTimeout(() => { pickVoice(); resolve(); }, 1000);
      });
    }

    function speakChunk(text, slow = true) {
      if (!('speechSynthesis' in window)) {
        showFeedback('Audio not supported in this browser', 'bg-gray-600');
        return;
      }
      ensureVoiceReady().then(() => {
        const u = new SpeechSynthesisUtterance(text);
        u.rate = slow ? 0.9 : 1.0; // slightly slower for readability
        u.pitch = 1.0;
        if (chosenVoice) u.voice = chosenVoice;
        u.lang = preferLang;
        synth.cancel(); // stop previous
        synth.speak(u);
      });
    }

    /***********************
      Small UI feedback helper
    ***********************/
    const feedbackBox = document.getElementById('feedbackBox');
    function showFeedback(message, bgClass) {
      feedbackBox.textContent = message;
      feedbackBox.style.display = 'block';
      // simple color mapping based on class-like name
      if (bgClass === 'bg-green-500') {
        feedbackBox.style.background = '#10b981';
      } else if (bgClass === 'bg-red-500') {
        feedbackBox.style.background = '#ef4444';
      } else if (bgClass === 'bg-gray-500') {
        feedbackBox.style.background = '#6b7280';
      } else if (bgClass === 'bg-blue-500') {
        feedbackBox.style.background = '#2563eb';
      } else {
        feedbackBox.style.background = '#111827';
      }
      setTimeout(() => { feedbackBox.style.display = 'none'; }, 1400);
    }

    /***********************
      Comprehension check
    ***********************/
    function checkAnswer(button, correct) {
      // style the chosen button
      const parent = button.parentElement;
      Array.from(parent.children).forEach(b => {
        b.classList.remove('bg-green-50', 'bg-red-50');
      });
      if (correct) {
        button.classList.add('bg-green-50');
        showFeedback('✔️ Great job!', 'bg-green-500');
      } else {
        button.classList.add('bg-red-50');
        showFeedback('❌ Try again!', 'bg-red-500');
      }
    }

    /***********************
      Drag & Drop: Idea Card
    ***********************/
    const card = document.getElementById('ideaCard');
    const dropTarget = document.getElementById('dropTarget');
    const dropText = document.getElementById('dropText');

    card.addEventListener('dragstart', (e) => {
      e.dataTransfer.setData('text/plain', e.target.dataset.concept);
      card.setAttribute('aria-grabbed', 'true');
      card.classList.add('opacity-60');
    });

    card.addEventListener('dragend', (e) => {
      card.setAttribute('aria-grabbed', 'false');
      card.classList.remove('opacity-60');
    });

    dropTarget.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropTarget.classList.add('bg-blue-50', 'border-[color:var(--primary-600)]');
    });

    dropTarget.addEventListener('dragleave', () => {
      dropTarget.classList.remove('bg-blue-50', 'border-[color:var(--primary-600)]');
    });

    dropTarget.addEventListener('drop', (e) => {
      e.preventDefault();
      dropTarget.classList.remove('bg-blue-50', 'border-[color:var(--primary-600)]');
      const data = e.dataTransfer.getData('text/plain');
      if (data === 'Natural Rights') {
        card.style.display = 'none';
        dropTarget.classList.add('bg-green-50', 'border-green-400');
        dropText.innerHTML = `<span class="text-green-700 font-bold">CARD SAVED!</span><br>${data} — Ready for Day 5!`;
        showFeedback('Card Saved!', 'bg-green-500');
      } else {
        showFeedback('Wrong card! Try again.', 'bg-red-500');
      }
    });

    /***********************
      Activity 2: Select Pictures
    ***********************/
    const freedomOptions = document.querySelectorAll('.freedom-option');
    const totalCorrectA2 = 3;
    freedomOptions.forEach(option => {
      // click and keyboard support
      const selectToggle = () => {
        const isSelected = option.classList.contains('selected');
        if (!isSelected) {
          option.classList.add('selected');
          option.setAttribute('aria-pressed', 'true');
        } else {
          option.classList.remove('selected');
          option.setAttribute('aria-pressed', 'false');
        }
        checkCompletionA2();
      };
      option.addEventListener('click', selectToggle);
      option.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          selectToggle();
        }
      });
    });

    function checkCompletionA2() {
      let correctSelections = 0;
      let incorrectSelections = 0;
      freedomOptions.forEach(option => {
        if (option.classList.contains('selected')) {
          if (option.dataset.correct === 'true') correctSelections++;
          else incorrectSelections++;
        }
      });
      if (correctSelections === totalCorrectA2 && incorrectSelections === 0) {
        showFeedback('Activity 2 Complete!', 'bg-blue-500');
      } else if (incorrectSelections > 0) {
        // gentle hint
        showFeedback('One choice is wrong. Check again.', 'bg-red-500');
      }
    }

    /***********************
      Activity 3: Drag & Drop Matching
    ***********************/
    const dragItems = document.querySelectorAll('.drag-item');
    const dropTargets = document.querySelectorAll('.drop-target');
    let correctDrops = 0;
    const totalDrops = 3;

    dragItems.forEach(item => {
      item.addEventListener('dragstart', (e) => {
        e.dataTransfer.setData('text/plain', e.target.dataset.right);
        item.classList.add('dragging');
        item.setAttribute('aria-grabbed', 'true');
      });
      item.addEventListener('dragend', (e) => {
        item.classList.remove('dragging');
        item.setAttribute('aria-grabbed', 'false');
      });
    });

    dropTargets.forEach(target => {
      target.addEventListener('dragover', (e) => {
        e.preventDefault();
        target.classList.add('drag-over');
      });
      target.addEventListener('dragleave', () => {
        target.classList.remove('drag-over');
      });
      target.addEventListener('drop', (e) => {
        e.preventDefault();
        target.classList.remove('drag-over');
        const draggedRight = e.dataTransfer.getData('text/plain');
        const acceptedRight = target.dataset.accept;
        const droppedElement = document.querySelector('[data-right="' + draggedRight + '"]');

        if (draggedRight === acceptedRight && !target.classList.contains('dropped')) {
          target.classList.add('dropped');
          droppedElement.classList.remove('bg-[color:var(--accent-500)]','bg-[color:var(--primary-600)]','bg-yellow-400');
          droppedElement.classList.add('bg-green-500','shadow-none','p-2');
          droppedElement.style.margin = '4px auto';
          droppedElement.style.cursor = 'default';
          droppedElement.draggable = false;
          target.innerHTML = '';
          target.appendChild(droppedElement);
          correctDrops++;
          showFeedback('Correct Match!', 'bg-green-500');
          if (correctDrops === totalDrops) {
            const feedbackArea = document.getElementById('dragDropFeedback');
            feedbackArea.textContent = "All Three Freedoms Matched! Great work on Day 1!";
            feedbackArea.classList.add('text-[color:var(--primary-600)]');
          }
        } else if (draggedRight !== acceptedRight) {
          showFeedback('Wrong Match! Try again.', 'bg-red-500');
        }
      });
    });

    /***********************
      Drawing pad (canvas)
    ***********************/
    const canvas = document.getElementById('drawingCanvas');
    const ctx = canvas.getContext('2d');
    const clearButton = document.getElementById('clearButton');
    const penColorInput = document.getElementById('penColor');
    const saveImageBtn = document.getElementById('saveImageBtn');

    let isDrawing = false;
    let lastX = 0;
    let lastY = 0;
    let currentColor = penColorInput.value;

    function resizeCanvas() {
      // maintain CSS size but set backing size for crispness
      const rect = canvas.getBoundingClientRect();
      canvas.width = Math.floor(rect.width * devicePixelRatio);
      canvas.height = Math.floor(rect.height * devicePixelRatio);
      ctx.scale(devicePixelRatio, devicePixelRatio);
      // fill background white
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0, 0, rect.width, rect.height);
      // default styles
      ctx.lineWidth = 5;
      ctx.lineJoin = 'round';
      ctx.lineCap = 'round';
    }

    // set an initial CSS height so the canvas has layout space
    canvas.style.height = '240px';
    canvas.style.width = '100%';

    window.addEventListener('load', () => { resizeCanvas(); });
    window.addEventListener('resize', () => { 
      // save drawing optionally? For now, clear on resize to keep simple
      resizeCanvas();
    });

    penColorInput.addEventListener('input', (e) => { currentColor = e.target.value; });

    clearButton.addEventListener('click', () => {
      const rect = canvas.getBoundingClientRect();
      ctx.clearRect(0, 0, rect.width, rect.height);
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0, 0, rect.width, rect.height);
      showFeedback('Canvas cleared', 'bg-gray-500');
    });

    function getPos(e) {
      const rect = canvas.getBoundingClientRect();
      let clientX, clientY;
      if (e.touches && e.touches.length > 0) {
        clientX = e.touches[0].clientX;
        clientY = e.touches[0].clientY;
      } else {
        clientX = e.clientX;
        clientY = e.clientY;
      }
      return { x: clientX - rect.left, y: clientY - rect.top };
    }

    function draw(e) {
      if (!isDrawing) return;
      e.preventDefault();
      const pos = getPos(e);
      ctx.beginPath();
      ctx.strokeStyle = currentColor;
      ctx.moveTo(lastX, lastY);
      ctx.lineTo(pos.x, pos.y);
      ctx.stroke();
      lastX = pos.x; lastY = pos.y;
    }

    function startDrawing(e) {
      isDrawing = true;
      const pos = getPos(e);
      lastX = pos.x; lastY = pos.y;
    }

    function stopDrawing() {
      isDrawing = false;
    }

    // mouse
    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', stopDrawing);
    canvas.addEventListener('mouseout', stopDrawing);
    // touch
    canvas.addEventListener('touchstart', startDrawing, {passive:false});
    canvas.addEventListener('touchmove', draw, {passive:false});
    canvas.addEventListener('touchend', stopDrawing);

    // Save as image
    saveImageBtn.addEventListener('click', () => {
      const rect = canvas.getBoundingClientRect();
      // create a new canvas to export with desired pixel ratio
      const exportCanvas = document.createElement('canvas');
      exportCanvas.width = rect.width;
      exportCanvas.height = rect.height;
      const exportCtx = exportCanvas.getContext('2d');
      // paint white background
      exportCtx.fillStyle = '#ffffff';
      exportCtx.fillRect(0, 0, exportCanvas.width, exportCanvas.height);
      // draw current canvas content
      // we need to draw from the display canvas; easiest way: use toDataURL from original
      try {
        const dataURL = canvas.toDataURL('image/png');
        const link = document.createElement('a');
        link.href = dataURL;
        link.download = 'my_freedom_drawing.png';
        link.click();
      } catch (err) {
        showFeedback('Cannot save image in this browser', 'bg-gray-500');
      }
    });

    /***********************
      Initialize some things on startup
    ***********************/
    // call ensure voice
    ensureVoiceReady().then(() => {
      // no UI change needed but voice should be selected if available
    });

  </script>
</body>
</html>
